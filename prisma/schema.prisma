generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  extensions = [postgis]
}

enum UserRole {
  ADMIN
  DISPATCHER
  DRIVER
  MEMBER
}

enum TripStatus {
  SCHEDULED
  ASSIGNED
  EN_ROUTE
  ARRIVED
  PICKED_UP
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Company {
  id               String   @id @default(uuid())
  name             String
  ahcccsProviderId String   @unique // The NEMT Provider ID
  address          String
  phone            String
  email            String   // For sending daily reports
  
  users            User[]
  trips            Trip[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  
  driverTrips Trip[] @relation("DriverTrips")
  memberTrips Trip[] @relation("MemberTrips")
  vehicle     Vehicle?
}

model Vehicle {
  id              String   @id @default(uuid())
  make            String
  model           String
  year            Int
  licensePlate    String   @unique
  vin             String   @unique
  driverId        String?  @unique
  driver          User?    @relation(fields: [driverId], references: [id])
  
  // PostGIS location
  currentLat      Float?
  currentLng      Float?
  
  isActive        Boolean  @default(true)
  updatedAt       DateTime @updatedAt
  
  trips           Trip[]
}

model Trip {
  id                  String     @id @default(uuid())
  memberId            String
  member              User       @relation("MemberTrips", fields: [memberId], references: [id])
  driverId            String?
  driver              User?      @relation("DriverTrips", fields: [driverId], references: [id])
  vehicleId           String?
  vehicle             Vehicle?   @relation(fields: [vehicleId], references: [id])
  
  companyId           String?    // To know which provider header to use
  company             Company?   @relation(fields: [companyId], references: [id])
  
  status              TripStatus @default(SCHEDULED)
  
  pickupAddress       String
  pickupLat           Float
  pickupLng           Float
  
  dropoffAddress      String
  dropoffLat          Float
  dropoffLng          Float
  
  scheduledPickupTime DateTime
  actualPickupTime    DateTime?
  actualDropoffTime   DateTime?
  
  // For Reporting
  driverSignatureUrl  String?
  memberSignatureUrl  String?
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}
